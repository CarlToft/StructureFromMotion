function T2=tritotri(T1);

% function T2=tritotri(T1);
% Determines the trifocal tensor between images 2, 1 and 3,
% given the trifocal tensor between images 1, 2 and 3.
%
% Input  T1=trifocal tensor between images 1, 2 and 3
% Output T2=trifocal tensor between images 2, 1 and 3

T2(1,1,1)=T1(2,2,1)*T1(3,3,1)-T1(3,2,1)*T1(2,3,1);
T2(1,1,2)=T1(2,2,2)*T1(3,3,2)-T1(3,2,2)*T1(2,3,2);
T2(1,1,3)=T1(2,2,3)*T1(3,3,3)-T1(3,2,3)*T1(2,3,3);

T2(1,2,1)=T1(3,2,1)*T1(1,3,1)-T1(1,2,1)*T1(3,3,1);
T2(1,2,2)=T1(3,2,2)*T1(1,3,2)-T1(1,2,2)*T1(3,3,2);
T2(1,2,3)=T1(3,2,3)*T1(1,3,3)-T1(1,2,3)*T1(3,3,3);

T2(1,3,1)=T1(1,2,1)*T1(2,3,1)-T1(2,2,1)*T1(1,3,1);
T2(1,3,2)=T1(1,2,2)*T1(2,3,2)-T1(2,2,2)*T1(1,3,2);
T2(1,3,3)=T1(1,2,3)*T1(2,3,3)-T1(2,2,3)*T1(1,3,3);


T2(2,1,1)=-T1(2,1,1)*T1(3,3,1)+T1(3,1,1)*T1(2,3,1);
T2(2,1,2)=-T1(2,1,2)*T1(3,3,2)+T1(3,1,2)*T1(2,3,2);
T2(2,1,3)=-T1(2,1,3)*T1(3,3,3)+T1(3,1,3)*T1(2,3,3);

T2(2,2,1)=-T1(3,1,1)*T1(1,3,1)+T1(1,1,1)*T1(3,3,1);
T2(2,2,2)=-T1(3,1,2)*T1(1,3,2)+T1(1,1,2)*T1(3,3,2);
T2(2,2,3)=-T1(3,1,3)*T1(1,3,3)+T1(1,1,3)*T1(3,3,3);

T2(2,3,1)=-T1(1,1,1)*T1(2,3,1)+T1(2,1,1)*T1(1,3,1);
T2(2,3,2)=-T1(1,1,2)*T1(2,3,2)+T1(2,1,2)*T1(1,3,2);
T2(2,3,3)=-T1(1,1,3)*T1(2,3,3)+T1(2,1,3)*T1(1,3,3);


T2(3,1,1)=T1(2,1,1)*T1(3,2,1)-T1(3,1,1)*T1(2,2,1);
T2(3,1,2)=T1(2,1,2)*T1(3,2,2)-T1(3,1,2)*T1(2,2,2);
T2(3,1,3)=T1(2,1,3)*T1(3,2,3)-T1(3,1,3)*T1(2,2,3);

T2(3,2,1)=T1(3,1,1)*T1(1,2,1)-T1(1,1,1)*T1(3,2,1);
T2(3,2,2)=T1(3,1,2)*T1(1,2,2)-T1(1,1,2)*T1(3,2,2);
T2(3,2,3)=T1(3,1,3)*T1(1,2,3)-T1(1,1,3)*T1(3,2,3);

T2(3,3,1)=T1(1,1,1)*T1(2,2,1)-T1(2,1,1)*T1(1,2,1);
T2(3,3,2)=T1(1,1,2)*T1(2,2,2)-T1(2,1,2)*T1(1,2,2);
T2(3,3,3)=T1(1,1,3)*T1(2,2,3)-T1(2,1,3)*T1(1,2,3);

% T2(:,j,k) har rätt skala

M1=[...
T1(1,1,1) T1(1,1,2) T1(1,1,3);...
T1(1,2,1) T1(1,2,2) T1(1,2,3);...
T1(1,3,1) T1(1,3,2) T1(1,3,3)];

M2=[...
T1(2,1,1) T1(2,1,2) T1(2,1,3);...
T1(2,2,1) T1(2,2,2) T1(2,2,3);...
T1(2,3,1) T1(2,3,2) T1(2,3,3)];

M3=[...
T1(3,1,1) T1(3,1,2) T1(3,1,3);...
T1(3,2,1) T1(3,2,2) T1(3,2,3);...
T1(3,3,1) T1(3,3,2) T1(3,3,3)];

[U,S,V]=svd(M1);
F1=V(:,3);
[U,S,V]=svd(M2);
F2=V(:,3);
[U,S,V]=svd(M3);
F3=V(:,3);

F13=[F1';F2';F3'];
[U,S,V]=svd(F13);
E13=V(:,3);

[U,S,V]=svd(M1');
F1=V(:,3);
[U,S,V]=svd(M2');
F2=V(:,3);
[U,S,V]=svd(M3');
F3=V(:,3);

F12=[F1';F2';F3'];
[U,S,V]=svd(F12);
E12=V(:,3);

T2(1,1,1)=T2(1,1,1)./E13(1);
T2(1,2,1)=T2(1,2,1)./E13(1);
T2(1,3,1)=T2(1,3,1)./E13(1);
T2(2,1,1)=T2(2,1,1)./E13(1);
T2(2,2,1)=T2(2,2,1)./E13(1);
T2(2,3,1)=T2(2,3,1)./E13(1);
T2(3,1,1)=T2(3,1,1)./E13(1);
T2(3,2,1)=T2(3,2,1)./E13(1);
T2(3,3,1)=T2(3,3,1)./E13(1);

T2(1,1,2)=T2(1,1,2)./E13(2);
T2(1,2,2)=T2(1,2,2)./E13(2);
T2(1,3,2)=T2(1,3,2)./E13(2);
T2(2,1,2)=T2(2,1,2)./E13(2);
T2(2,2,2)=T2(2,2,2)./E13(2);
T2(2,3,2)=T2(2,3,2)./E13(2);
T2(3,1,2)=T2(3,1,2)./E13(2);
T2(3,2,2)=T2(3,2,2)./E13(2);
T2(3,3,2)=T2(3,3,2)./E13(2);

T2(1,1,3)=T2(1,1,3)./E13(3);
T2(1,2,3)=T2(1,2,3)./E13(3);
T2(1,3,3)=T2(1,3,3)./E13(3);
T2(2,1,3)=T2(2,1,3)./E13(3);
T2(2,2,3)=T2(2,2,3)./E13(3);
T2(2,3,3)=T2(2,3,3)./E13(3);
T2(3,1,3)=T2(3,1,3)./E13(3);
T2(3,2,3)=T2(3,2,3)./E13(3);
T2(3,3,3)=T2(3,3,3)./E13(3);
